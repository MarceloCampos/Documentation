# In-Field Update
---
TinyCLR OS allows for secure, encrypted, In-Field Update (IFU) of your application. The updates can be done from application code stored in a buffer or read over file system.

> [!Note]
> The application key is generated by the TinyCLR Config tool when you create your application.

## Update via Buffer
Systems with external memory can use the buffer updater, which first copies the new update from a file, network, or bus, and stores it in a buffer. When the entire firmware file is in memory, the IFU will then check the buffer for authenticity. Only then will it decrypt the data and flash it into the chip's internal memory.

This is the recommended update mode; however, this will only work on systems with external memory.

> [!Warning]
> Be careful not to interrupt power during application for firmware updates. A power interruption will cause the update to fail making it necessary to manually update your board.

> [!Tip]
> Needed NuGets: GHIElectronics.TinyCLR.Core, GHIElectronics.TinyCLR.Devices.Storage, GHIElectronics.TinyCLR.IO, GHIElectronics.TinyCLR.Native, GHIElectronics.TinyCLR.Update.

```csharp
using GHIElectronics.TinyCLR.Devices.Storage;
using GHIElectronics.TinyCLR.IO;
using GHIElectronics.TinyCLR.Native;
using GHIElectronics.TinyCLR.Update;
using System.IO;

class Program {
    private static void Main() {
        const string FSSD_API_CONTROLLER = 
            @"GHIElectronics.TinyCLR.NativeApis.STM32H7.SdCardStorageController\0";

        const string FSUSB_API_CONTROLLER = 
            @"GHIElectronics.TinyCLR.NativeApis.STM32H7.UsbHostMassStorageStorageController\0";

        var media = StorageController.FromName(FSSD_API_CONTROLLER); //Update from SD card.
        var drive = FileSystem.Mount(media.Hdc);

        FileStream fsFw = new FileStream(@"A:\sc20xxx Firmware.ghi", FileMode.Open);
        FileStream fsApp = new FileStream(@"A:\yourApplication.tca", FileMode.Open);

        InFieldUpdate updater;
        
        UnmanagedBuffer fwUnmagedBuf = new UnmanagedBuffer((int)fsFw.Length);
        UnmanagedBuffer fwUnmagedApp = new UnmanagedBuffer((int)fsApp.Length);

        var fwBuf = fwUnmagedBuf.Bytes;
        var appBuf = fwUnmagedApp.Bytes;

        fsFw.Read(fwBuf, 0, fwBuf.Length);
        fsApp.Read(appBuf, 0, appBuf.Length);

        updater = new InFieldUpdate(fwBuf, appBuf);

        updater.ApplicationKey = new byte[] { }; //Add key as byte array here.

        try {
            updater.AuthenticateFirmware(out var versionFw);
        }
        catch {
            //Firmware authentication failed.
        }

        try {
            updater.AuthenticateApplication(out var versionApp);
        }
        catch {
            //Application authentication failed.
        }

        updater.FlashAndReset();
    }
}
```

## Update via File

The file updater reads files from memory, SD card or USB port, and then handles the updated directly without the need for external memory. This update works on systems with or without external memory. You cannot update the firmware using this method, only the application.

> [!Warning]
> Be careful not to interrupt power during updating your board. A power interruption will cause the update to fail making it necessary to manually update your board.

> [!Tip]
> Needed NuGets: GHIElectronics.TinyCLR.Core, GHIElectronics.TinyCLR.Devices.Storage, GHIElectronics.TinyCLR.IO, GHIElectronics.TinyCLR.Update.

```csharp
using GHIElectronics.TinyCLR.Devices.Storage;
using GHIElectronics.TinyCLR.IO;
using GHIElectronics.TinyCLR.Update;
using System.IO;

class Program {
    private static void Main() {
        const string FSSD_API_CONTROLLER =
            @"GHIElectronics.TinyCLR.NativeApis.STM32H7.SdCardStorageController\0";

        const string FSUSB_API_CONTROLLER =
            @"GHIElectronics.TinyCLR.NativeApis.STM32H7.UsbHostMassStorageStorageController\0";

        var media = StorageController.FromName(FSSD_API_CONTROLLER); //Using SD card.
        var drive = FileSystem.Mount(media.Hdc);

        FileStream fsApp = new FileStream(@"A:\yourApplication.tca", FileMode.Open);

        InFieldUpdate updater;

        updater = new InFieldUpdate(fsApp);

        updater.ApplicationKey = new byte[] { }; //Add key as byte array here.

        try {
            updater.AuthenticateApplication(out var versionApp);
        }
        catch {
            //Application authentication failed.
        }

        updater.FlashAndReset();
    }
}

```

## Firmware and Application Matching
It is important that the firmware on your chip is the same version expected by your application. To make sure your application and firmware match, it is best to update both simultaneously if possible.
