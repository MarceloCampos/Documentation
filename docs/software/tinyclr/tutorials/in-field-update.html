<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>In-Field Update </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="In-Field Update ">
    <meta name="generator" content="docfx 2.23.1.0">
    
    <link rel="shortcut icon" href="../../../images/favicon.ico">
    <link rel="stylesheet" href="../../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../../styles/docfx.css">
    <link rel="stylesheet" href="../../../styles/main.css">
    <meta property="docfx:navrel" content="../../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    <meta property="docfx:rel" content="../../../">
    <meta property="docfx:newtab" content="true">
  </head>
  <body data-spy="scroll" data-target="#affix">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../../index.html">
                <img id="logo" class="svg" src="../../../images/logo.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items"></div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="in-field-update">In-Field Update</h1>

<hr>
<p>TinyCLR OS allows for secure, encrypted, In-Field Update (IFU) of your application. The updates can be done from application code stored in a buffer or read over file system.</p>
<div class="NOTE"><h5>Note</h5><p>The application key is generated by the TinyCLR Config tool when you create your application.</p>
</div>
<h2 id="update-via-buffer">Update via Buffer</h2>
<p>Systems with external memory can use the buffer updater, which first copies the new update from a file, network, or bus, and stores it in a buffer. When the entire firmware file is in memory, the IFU will then check the buffer for authenticity. Only then will it decrypt the data and flash it into the chip&#39;s internal memory.</p>
<p>This is the recommended update mode; however, this will only work on systems with external memory.</p>
<div class="WARNING"><h5>Warning</h5><p>Be careful not to interrupt power during application for firmware updates. A power interruption will cause the update to fail making it necessary to manually update your board.</p>
</div>
<div class="TIP"><h5>Tip</h5><p>Needed NuGets: GHIElectronics.TinyCLR.Core, GHIElectronics.TinyCLR.Devices.Storage, GHIElectronics.TinyCLR.IO, GHIElectronics.TinyCLR.Native, GHIElectronics.TinyCLR.Update.</p>
</div>
<pre><code class="lang-cs">using GHIElectronics.TinyCLR.Devices.Storage;
using GHIElectronics.TinyCLR.IO;
using GHIElectronics.TinyCLR.Native;
using GHIElectronics.TinyCLR.Update;
using System.IO;

class Program {
    private static void Main() {
        const string FSSD_API_CONTROLLER = 
            @&quot;GHIElectronics.TinyCLR.NativeApis.STM32H7.SdCardStorageController\0&quot;;

        const string FSUSB_API_CONTROLLER = 
            @&quot;GHIElectronics.TinyCLR.NativeApis.STM32H7.UsbHostMassStorageStorageController\0&quot;;

        var media = StorageController.FromName(FSSD_API_CONTROLLER); //Update from SD card.
        var drive = FileSystem.Mount(media.Hdc);

        FileStream fsFw = new FileStream(@&quot;A:\sc20xxx Firmware.ghi&quot;, FileMode.Open);
        FileStream fsApp = new FileStream(@&quot;A:\yourApplication.tca&quot;, FileMode.Open);

        InFieldUpdate updater;

        UnmanagedBuffer fwUnmagedBuf = new UnmanagedBuffer((int)fsFw.Length);
        UnmanagedBuffer fwUnmagedApp = new UnmanagedBuffer((int)fsApp.Length);

        var fwBuf = fwUnmagedBuf.Bytes;
        var appBuf = fwUnmagedApp.Bytes;

        fsFw.Read(fwBuf, 0, fwBuf.Length);
        fsApp.Read(appBuf, 0, appBuf.Length);

        updater = new InFieldUpdate(fwBuf, appBuf);

        updater.ApplicationKey = new byte[] { }; //Add key as byte array here.

        try {
            updater.AuthenticateFirmware(out var versionFw);
        }
        catch {
            //Firmware authentication failed.
        }

        try {
            updater.AuthenticateApplication(out var versionApp);
        }
        catch {
            //Application authentication failed.
        }

        updater.FlashAndReset();
    }
}
</code></pre><h2 id="update-via-file">Update via File</h2>
<p>The file updater reads files from memory, SD card or USB port, and then handles the updated directly without the need for external memory. This update works on systems with or without external memory. You cannot update the firmware using this method, only the application.</p>
<div class="WARNING"><h5>Warning</h5><p>Be careful not to interrupt power during updating your board. A power interruption will cause the update to fail making it necessary to manually update your board.</p>
</div>
<div class="TIP"><h5>Tip</h5><p>Needed NuGets: GHIElectronics.TinyCLR.Core, GHIElectronics.TinyCLR.Devices.Storage, GHIElectronics.TinyCLR.IO, GHIElectronics.TinyCLR.Update.</p>
</div>
<pre><code class="lang-cs">using GHIElectronics.TinyCLR.Devices.Storage;
using GHIElectronics.TinyCLR.IO;
using GHIElectronics.TinyCLR.Update;
using System.IO;

class Program {
    private static void Main() {
        const string FSSD_API_CONTROLLER =
            @&quot;GHIElectronics.TinyCLR.NativeApis.STM32H7.SdCardStorageController\0&quot;;

        const string FSUSB_API_CONTROLLER =
            @&quot;GHIElectronics.TinyCLR.NativeApis.STM32H7.UsbHostMassStorageStorageController\0&quot;;

        var media = StorageController.FromName(FSSD_API_CONTROLLER); //Using SD card.
        var drive = FileSystem.Mount(media.Hdc);

        FileStream fsApp = new FileStream(@&quot;A:\yourApplication.tca&quot;, FileMode.Open);

        InFieldUpdate updater;

        updater = new InFieldUpdate(fsApp);

        updater.ApplicationKey = new byte[] { }; //Add key as byte array here.

        try {
            updater.AuthenticateApplication(out var versionApp);
        }
        catch {
            //Application authentication failed.
        }

        updater.FlashAndReset();
    }
}
</code></pre><h2 id="firmware-and-application-must-match">Firmware and Application Must Match</h2>
<p>It is important that the firmware on your chip is the same version expected by your application. To make sure your application and firmware match, it is best to update both simultaneously if possible.</p>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/ghi-electronics/Documentation/blob/add-tutorials/software/tinyclr/tutorials/in-field-update.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <span>Copyright © 2020 GHI Electronics, LLC<br>Generated by <strong>DocFX</strong></span>
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../../styles/main.js"></script>
  </body>
</html>
